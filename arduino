//MAX485

#include <SoftwareSerial.h>  

#define RX        11    //RX
#define TX        10    //TX
#define RTS_pin    9    //RS485 Direction control
#define RS485Transmit    HIGH
#define RS485Receive     LOW
int wind = 0; //unit: km/h

SoftwareSerial RS485Serial(RX, TX);

void setup() {

  pinMode(RTS_pin, OUTPUT);  
  
  // Start the built-in serial port, for Serial Monitor
  Serial.begin(9600);
  Serial.println("Anemometer"); 

  // Start the Modbus serial Port, for anemometer
  RS485Serial.begin(4800);   
  delay(1000);
}

void loop() {

  digitalWrite(RTS_pin, RS485Transmit);     // init Transmit
  byte Anemometer_request[] = {0x01, 0x03, 0x00, 0x00, 0x00, 0x01, 0x84, 0x0A}; // inquiry frame
  RS485Serial.write(Anemometer_request, sizeof(Anemometer_request));
  RS485Serial.flush();
  
  digitalWrite(RTS_pin, RS485Receive);      // Init Receive
  byte Anemometer_buf[8];
  RS485Serial.readBytes(Anemometer_buf, 8);
  if(Anemometer_buf[1]==1)
  {
 
  Serial.print("wind speed : ");
  for( byte i=0; i<8; i++ ) {
  Serial.print(Anemometer_buf[i], HEX);
  Serial.print(" ");
  }
 
   Serial.print(" ==> ");
  //Serial.print(Anemometer_buf[5]);
  wind = Anemometer_buf[5]*0.36;
  Serial.print(wind);
  Serial.println("km/h");                
  delay(100);
  }

}
